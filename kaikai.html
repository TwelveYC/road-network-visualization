<!DOCTYPE html>
<html>
	<head>
		<title>违章轨迹回放</title>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<meta name="viewport" content="initial-scale=1, maximum-scale=1,user-scalable=no">
		<link rel="stylesheet" href="https://js.arcgis.com/3.28/dijit/themes/claro/claro.css">
		<link rel="stylesheet" href="https://js.arcgis.com/3.28/esri/css/esri.css">
		<style>
			html,
			body,
			#mapDiv {
				padding: 0;
				margin: 0;
				height: 100%;
			}
			
			#bottomPanel {
				left: 50%;
				margin: 0 auto;
				margin-left: -500px;
				position: absolute;
				bottom: 2.5em;
			}
			
			#timeInfo {
				border-radius: 4px;
				border: solid 2px #ccc;
				background-color: #fff;
				display: block;
				padding: 5px;
				position: relative;
				text-align: center;
				width: 1000px;
				z-index: 99;
			}
			
			#op {
				right: 15px;
				margin: 0 auto;
				margin-right: 100px;
				position: absolute;
				bottom: 3.4em;
				z-index: 99;
			}
			
			#fanhui3 {
				width: 60px;
				height: 40px;
				background: blueviolet;
				color: white;
			}
		</style>
		<!-- <script src="js/jquery-3.3.1.min.js"></script> -->
		<script src="http://code.jquery.com/jquery-2.1.1.min.js"></script>
		<!--此处为引用的离线api-->
		<script src="https://js.arcgis.com/3.28/init.js"></script>
		<script>
			var map;
			var c0;
			var timestamp22;
			var objectList = new Array(); //创建按照时间排序之后的数组	
			var longitude = new Array(); //定义存放查询到经度的数组
			var latitude = new Array(); //定义存放查询到纬度的数组
			var adsbflight;
			var timestamp = new Array(); //定义存放查询到时间戳的数组
			var nt = new Date();
			var adsbtime, timestamp2;
			var nt1, nt2;
			//倍速功能用到的函数
			function setCookie(name, value) {
				var exp = new Date();
				exp.setTime(exp.getTime() + 24 * 60 * 60 * 1000);
				document.cookie = name + "=" + escape(value) + ";expires=" + exp.toGMTString();//document.cookie
				//window.location.href="f1113.html"; //此种方法会出错
				location.reload(); //重新载入界面
			}
			//倍速功能用到的函数
			function getCookie(name) {
				var regExp = new RegExp("(^| )" + name + "=([^;]*)(;|$)");
				var arr = document.cookie.match(regExp);
				if(arr == null) {
					return null;
				}
				return unescape(arr[2]);
			}
			//显示线路按钮的功能，将复选框勾选上，设为true
			function check() {
				document.getElementById("myCheck").checked = true
			}
			var refreshtime;

			//创建排序对象，数组排序用到的函数
			//对数组进行排序主要因为查询到的数据并不是按照时间顺序排序出来的，而且在创建线的过程要考虑点的顺序，所以要进行排序
			function Persion(lon, lat,timestamp) {
				this.lon = lon;
				this.lat = lat;
				this.timestamp = timestamp;
			}

			require([
				"esri/map",
				"esri/layers/ArcGISDynamicMapServiceLayer",
				"esri/layers/GraphicsLayer",
				"dojo/dom", "dojo/on",
				"esri/tasks/query", "esri/tasks/QueryTask",
				"esri/geometry/Point", "esri/geometry/Polyline", "esri/SpatialReference", "esri/Color",
				"esri/symbols/SimpleMarkerSymbol", "esri/symbols/SimpleLineSymbol", "esri/graphic", "esri/InfoTemplate",
				"esri/TimeExtent", "esri/dijit/TimeSlider",
				"dojo/_base/array", "dojo/dom", "dojo/domReady!"
			], function(
				Map, ArcGISDynamicMapServiceLayer, GraphicsLayer, dom, on, Query, QueryTask, Point, Polyline, SpatialReference, Color, SimpleMarkerSymbol, SimpleLineSymbol, Graphic, InfoTemplate, TimeExtent, TimeSlider, arrayUtils) {
				var queryTask = new QueryTask("https://172.16.200.9:6443/arcgis/rest/services/APPUserLocation/MapServer/0"); //导入应用的地图图层			
				var query = new Query();
				query.returnGeometry = true;
				query.outFields = ["appuser_id", "latitude", "longtitude", "timestamp"]; //定义返回的字段
				//on(dom.byId("execute"), "click", execute); //点击按钮执行的操作
				adsbtime = "2019-11-26 14:07:30"; //获取时间的输入
				timestamp2 = Date.parse(new Date(adsbtime)); //读取输入时间的时间戳
				nt = new Date(); //定义一个新时间
				nt1 = nt.setTime(timestamp2 + 60 * 2000); //设置新时间比旧时间多1分钟
				nt2 = nt.setTime(timestamp2 - 60 * 2000); //设置新时间比旧时间少1分钟
				var nt3 = nt1 / 1000;
				var nt4 = nt2 / 1000;
				query.where = "timestamp >=" + nt4 + "and timestamp <=" + nt3; //多条件查询
				queryTask.execute(query, showResults); //查询之后的显示

				var pointgraphic = new Array(); //用于存放所有点图形
				var linegraphicarr = new Array(); //用于存放所有线图形
				var timestamp21arr = new Array(); //用于存放所有点的时间戳
				var timestamp211arr = new Array(); //用于存放添加到图层所有点的时间戳

				function showResults(results) {
					var resultCount = results.features.length; //定义查询返回要素的长度
					//遍历所有查询到的要素
					for(var i = 0; i < resultCount; i++) {
						var featureAttributes = results.features[i].attributes;
						for(var attr in featureAttributes) {
							if(attr == "timestamp") {
								timestamp1 = featureAttributes[attr]; //读取点坐标时间的时间戳
								//console.log(timestamp1);
								timestamp.push(timestamp1); //将查询到的时间戳放进数组
							}
						}
					}
					//遍历所有查询到的要素，查询经度
					for(var i = 0; i < resultCount; i++) {
						var lon = results.features[i].geometry.x; //读取要素的经度
						longitude.push(lon); //将查询到的经度放进数组
					}
					//查询纬度
					for(var i = 0; i < resultCount; i++) {
						var lat = results.features[i].geometry.y; //读取要素的纬度
						latitude.push(lat); //将查询到的纬度放进数组
					}
					//遍历 并将排好的顺序加入新的数组
					for(var j = 0; j < longitude.length; j++) {
						//console.log(1);
						objectList.push(new Persion(longitude[j], latitude[j], timestamp[j]));		
					}
					//sort函数，排序函数
					objectList.sort(function(a, b) {
						//console.log(1);
						return a.timestamp - b.timestamp;
						
					});
					//创建所有点图形，遍历所有查询的点
					for(var i = 0; i < longitude.length; i++) {
						var a1 = objectList[i].lon; //定义点坐标的经度
						var b1 = objectList[i].lat; //定义点坐标的纬度
						//console.log(a1);
						var point = new Point({
							longitude: a1,
							latitude: b1
						}); //创建点
                        
						// Create a symbol for drawing the point  为画点创建符号
						var markerSymbol = new SimpleMarkerSymbol();
						markerSymbol.setColor(new Color([226, 119, 40]));

						// Create attributes  创建属性信息
						var attributes = {
							Name: adsbflight, // The name of the pipeline
							//Time: objectList[i].time, // The owner of the pipeline
							City: "Los Angeles", // The length of the pipeline
							longitude: a1,
							latitude: b1,
						};
						
						// Create a graphic and add the geometry and symbol to it  创建弹出框来存放标题和属性信息
						var json = {
							title: "Attributes",
							content: "Flight number: ${Name}<br>Longitude: ${longitude}<br>Latitude: ${latitude}"
						}
						var infoTemplate = new InfoTemplate(json);
						var graphic = new Graphic(point, markerSymbol, attributes, infoTemplate); //将点创建出来
						timestamp21 = objectList[i].timestamp; //时间戳为m
						//console.log(objectList[i].lon);
						//console.log(objectList[i].lat);
                        //console.log(objectList[i].timestamp);  //
						//timestamp21 = Date.parse(new Date(objectList[i].time)); //读取点坐标时间的时间戳
						timestamp21arr.push(timestamp21); //将点的时间戳存放到数组
						pointgraphic.push(graphic); //将点图形存放到数组
						//console.log(pointgraphic.length);
					} //FOR循环终点

					//创建所有线图形，遍历所有查询的点。线的数量比点的数量少1
					for(var i = 0; i < longitude.length - 1; i++) {
						var polyline = new Polyline(); //创建线
						polyline.addPath([
							[objectList[i].lon, objectList[i].lat],
							[objectList[i + 1].lon, objectList[i + 1].lat]
						]); //添加线的两个点
						var linesymbol = new SimpleLineSymbol(); //创建线的符号
						linesymbol.setWidth(5) //设置线的宽度
						linesymbol.setColor(new Color([226, 119, 40]));; //设置线的颜色
						var linegraphic = new Graphic(polyline, linesymbol); //将线创建出来了
						linegraphicarr.push(linegraphic); //将创建的线加入数组
					}
				} //showResults函数结尾
				//定义地图，加载图层
				map = new Map("mapDiv",{
					basemap:"topo",
					center:[126.678,45.755],
					zoom:17
				});
				//Takes a URL to a non cached map service.
				var dynamicMapServiceLayer = new ArcGISDynamicMapServiceLayer("https://172.16.200.9:6443/arcgis/rest/services/secondcampus/MapServer");
				map.addLayer(dynamicMapServiceLayer); //加载动态地图
				pointlayer = new GraphicsLayer();
				map.addLayer(pointlayer); //加载点图层
				linelayer = new GraphicsLayer();
				map.addLayer(linelayer); //加载线图层
				
				//var dynamicMapServiceLayer = new ArcGISDynamicMapServiceLayer("https://172.16.200.9:6443/arcgis/rest/services/secondcampus/MapServer",{"opacity":0.5});
				//map.addLayer(dynamicMapServiceLayer); //加载动态地图

				map.on("load", initSlider); //地图加载之后，加载initSlider函数，加载时间控件

				/*var timestamp3 = paValue[3][0];  //获取新时间比旧时间多1分钟时间戳
				var timestamp4 = paValue[4][0];  //获取新时间比旧时间少1分钟时间戳
				//转换为s
				var timestamp31 = timestamp3 / 1000;   
				var timestamp41 = timestamp4 / 1000;*/
				var nt11 = nt1 / 1000;
				var nt22 = nt2 / 1000;

				//获取时间轴上最大的时间，分别获取年月日时分秒
				var maxdate = new Date(parseInt(nt11) * 1000);
				var maxY = maxdate.getFullYear();
				var maxM = (maxdate.getMonth() + 1 < 10 ? '0' + (maxdate.getMonth() + 1) : maxdate.getMonth() + 1);
				var maxD = maxdate.getDate() < 10 ? '0' + maxdate.getDate() : maxdate.getDate();
				var maxh = maxdate.getHours();
				var maxm = maxdate.getMinutes();
				var maxs = maxdate.getSeconds();
				//获取时间轴上最小的时间，分别获取年月日时分秒
				var mindate = new Date(parseInt(nt22) * 1000);
				var minY = mindate.getFullYear();
				var minM = (mindate.getMonth() + 1 < 10 ? '0' + (mindate.getMonth() + 1) : mindate.getMonth() + 1);
				var minD = mindate.getDate() < 10 ? '0' + mindate.getDate() : mindate.getDate();
				var minh = mindate.getHours();
				var minm = mindate.getMinutes();
				var mins = mindate.getSeconds();

				var endValString;
				var timestamp22arr = new Array(); //定义时间轴被点击时间戳的数值

				function initSlider() {
					var timeSlider = new TimeSlider({
						style: "width: 100%;"
					}, dom.byId("timeSliderDiv"));
					map.setTimeSlider(timeSlider);
					var timeExtent = new TimeExtent();
					timeExtent.startTime = new Date(minY, minM - 1, minD, minh, minm, mins); //YYY-MM-DD HH:MM:SS   //时间轴的起时间
					timeExtent.endTime = new Date(maxY, maxM - 1, maxD, maxh, maxm, maxs); //YYY-MM-DD HH:MM:SS   //时间轴的终止时间
					timeSlider.setThumbCount(1); //指针数量
					timeSlider.createTimeStopsByTimeInterval(timeExtent, 1, "esriTimeUnitsSeconds");
					timeSlider.setThumbIndexes([0, 1]); //确定放置指针的位置
					timeSlider.setThumbMovingRate(refreshtime); //播放的速度
					timeSlider.startup();

					//标题时间的变化，点击事件
					timeSlider.on("time-extent-change", function(evt) {
						var startValString = evt.startTime.toLocaleString();
						endValString = evt.endTime.toLocaleString();
						var year = evt.endTime.getFullYear();
						var month = evt.endTime.getMonth();
						var day = evt.endTime.getDate();
						var hour = evt.endTime.getHours();
						var min = evt.endTime.getMinutes();
						var s = evt.endTime.getSeconds();
						c0 = new Date(year, month, day, hour, min, s);
						timestamp22 = Date.parse(new Date(c0)); //读取点击时间的时间戳
						//console.log(timestamp22); //时间戳为ms
						timestamp222 = timestamp22/1000;
						//console.log(timestamp222);
						timestamp22arr.push(timestamp222); //将时间戳放进数组
						dom.byId("daterange").innerHTML = "<i>" + startValString + " 到 " + endValString + "<\/i>"; //标题显示
					});
				}

				//按时间排序    与person对象对接
				//console.log(longitude.length);

				var myVar = setInterval(function() {
					myrefresh()
				}, refreshtime); //定时自动更新myrefresh函数
				//实现轨迹回放的关键
				function myrefresh() {
					if(timestamp22arr.length == 1) {
						//时间轴第一次发生变化
						for(var j = 0; j < pointgraphic.length; j++) { //遍历所有点
							if(timestamp21arr[j] <= timestamp222) { //如果点坐标小于等于时间轴的坐标
								if(timestamp211arr.includes(timestamp21arr[j]) == false) { //因为在刷新，不可以重复加入
									pointlayer.add(pointgraphic[j]); //将点加入点图层
									timestamp211arr.push(timestamp21arr[j]); //将添加到图层的所有点的时间戳到数组 
									if(timestamp211arr.length > 1) {
										linelayer.add(linegraphicarr[j - 1]); //如果点图层中点的个数大于1，开始加线
									}
								}
							}
						}
					} else if(timestamp22arr.length > 1) {
						//本来想在此处加上判断下一次时间轴变化与前一次变化的大小，但是由于正常播放与回退会发生冲突，所以会出现bug
						//var timestamp222 = timestamp22arr[timestamp22arr.length-1] - timestamp22arr[timestamp22arr.length-2];			    		
						for(var j = timestamp211arr.length; j < pointgraphic.length; j++) { //遍历未加入图层的点
							if(timestamp21arr[j] <= timestamp222) { //如果点坐标小于等于时间轴的坐标
								pointlayer.add(pointgraphic[j]); //将点加入点图层
								timestamp211arr.push(timestamp21arr[j]); //将添加到图层的所有点的时间戳到数组         
								linelayer.add(linegraphicarr[j - 1]); //添加线到线图层
							}
						}
						for(var j = timestamp211arr.length; j >= 0; j--) { //遍历所有加入点图层的点
							if(timestamp21arr[j] > timestamp222) { //如果点坐标大于时间轴的坐标
								pointlayer.remove(pointgraphic[j]); //将点移除点图层
								if(timestamp211arr.length > 0) {
									linelayer.remove(linegraphicarr[j - 1]); //如果点图层上点的数量时才会有线，才会出现将线移除线图层
								}
								timestamp211arr.pop(timestamp21arr[j]); //将添加到图层的所有点的时间戳到数组    
							}
						}
					}
				} //myrefresh函数终点

				//由于需要显示线路/隐藏线路的功能，所以需要不断地刷新
				var myVar1 = setInterval(function() {
					myrefresh1()
				}, refreshtime); //定时自动更新myrefresh1函数
				function myrefresh1() {
					if(myCheck.checked == false) {
						linelayer.setVisibility(false); //如果为选中显示线路，设置线图层为不可见
					} else if(myCheck.checked == true) {
						linelayer.setVisibility(true); //如果选中显示线路，设置线图层为可见
					}
				}
			});
		</script>
	</head>

	<body>
				<div id="mapDiv">
					<div id="bottomPanel">
						<div id="timeInfo">
							<div>轨迹时间从<span id="daterange">开始 to 结束</span> </div>
							<div id="timeSliderDiv"></div>
						</div>
					</div>
					<div id="op">
						<select name="select_1" id="select_1" style="width:120px;height:40px;" onchange="setCookie('select_1',this.selectedIndex)">
							<option value="0">播放速度设置</option>
							<option value="1">0.5倍速</option>
							<option value="2">0.75倍速</option>
							<option value="3">1.0倍速</option>
							<option value="4">1.5倍速</option>
							<option value="5">2.0倍速</option>
						</select>

						<input type="checkbox" id="myCheck" style="width:20px;height:20px;" />
						<button id="fanhui1" style="width: 80px; height: 40px;background:blueviolet;color:white;" onclick="check()">显示线路</button>
						<button id="fanhui3" class="btn" onclick="window.location.href='f1111.html'"> 返回</button>

					</div>
				</div>
				<script type="text/javascript">
					//倍速播放用到的函数   body里面的js函数是在内容加载时就在加载，而head里面的js函数是在被调用时加载
					var selectedIndex = getCookie("select_1");
					if(selectedIndex != null) {
						document.getElementById("select_1").selectedIndex = selectedIndex;
						if(selectedIndex == 0) {
							refreshtime = 1000;
						} else if(selectedIndex == 1) {
							refreshtime = 1000000 / 500;
						} else if(selectedIndex == 2) {
							refreshtime = 1000000 / 750;
						} else if(selectedIndex == 3) {
							refreshtime = 1000000 / 1000;
						} else if(selectedIndex == 4) {
							refreshtime = 1000000 / 1500;
						} else if(selectedIndex == 5) {
							refreshtime = 1000000 / 2000;
						}
					}
				</script>

	</body>

</html>